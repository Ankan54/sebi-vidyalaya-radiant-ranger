{% extends "base.html" %}

{% block title %}{{ exam_type }} - SEBI Vidyalaya{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// Configure marked.js to support tables and other features
marked.setOptions({
    tables: true,
    breaks: true,
    gfm: true, // GitHub Flavored Markdown
    headerIds: false,
    mangle: false
});
</script>
<style>
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.chat-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 0;
    box-shadow: 0 20px 60px rgba(0,0,0,0.1);
}

.chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 0;
    position: relative;
    overflow: hidden;
}

.tab-navigation {
    display: flex;
    gap: 0.5rem;
    position: relative;
    z-index: 2;
}

.tab-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    backdrop-filter: blur(10px);
}

.tab-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.tab-btn.active {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transform: translateY(-1px);
}

.tab-btn i {
    font-size: 1rem;
}

.chat-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
}

.chat-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    position: relative;
    z-index: 1;
}

.chat-subtitle {
    font-size: 0.9rem;
    opacity: 0.9;
    margin: 0.5rem 0 0 0;
    position: relative;
    z-index: 1;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 2rem 1.5rem;
    background: #fafafa;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.message {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    animation: messageSlideIn 0.3s ease-out;
}

.message-user {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
    font-weight: 500;
}

.message-user .message-avatar {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.message-ai .message-avatar {
    background: #e3f2fd;
    color: #1976d2;
}

.message-content {
    max-width: 70%;
    position: relative;
}

.message-bubble {
    padding: 1rem 1.25rem;
    border-radius: 1.25rem;
    font-size: 0.95rem;
    line-height: 1.5;
    position: relative;
    word-wrap: break-word;
}

.message-user .message-bubble {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-bottom-right-radius: 0.5rem;
}

.message-ai .message-bubble {
    background: white;
    color: #2d3748;
    border: 1px solid #e2e8f0;
    border-bottom-left-radius: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.message-time {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.5rem;
    text-align: center;
}

.message-user .message-time {
    text-align: right;
}

.message-ai .message-time {
    text-align: left;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    animation: messageSlideIn 0.3s ease-out;
}

.typing-bubble {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 1.25rem;
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.typing-dots {
    display: flex;
    gap: 0.25rem;
    align-items: center;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #cbd5e0;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

.typing-text {
    font-size: 0.9rem;
    color: #64748b;
    margin-left: 0.5rem;
}

.chat-input-container {
    padding: 1.5rem;
    background: white;
    border-top: 1px solid #e2e8f0;
}

.input-wrapper {
    position: relative;
    background: #f8fafc;
    border-radius: 1.5rem;
    border: 2px solid #e2e8f0;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    padding: 0.5rem;
}

.input-wrapper:focus-within {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.message-input {
    flex: 1;
    border: none;
    background: transparent;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    resize: none;
    outline: none;
    font-family: inherit;
    min-height: 44px;
    max-height: 120px;
}

.input-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 1rem;
}

.action-btn:hover {
    transform: scale(1.05);
}

.attach-btn {
    background: #e3f2fd;
    color: #1976d2;
}

.attach-btn:hover {
    background: #bbdefb;
}

.voice-btn {
    background: #f3e5f5;
    color: #7b1fa2;
}

.voice-btn:hover {
    background: #e1bee7;
}

.voice-btn.recording {
    background: #ffebee;
    color: #d32f2f;
    animation: pulse 1.5s infinite;
}

.send-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.send-btn:hover {
    background: linear-gradient(135deg, #5a6fd8, #6a4190);
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.status-indicator {
    padding: 1rem 1.5rem;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 0.75rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-indicator.success {
    background: #d1edff;
    border-color: #74c0fc;
    color: #0c4a6e;
}

.status-indicator.error {
    background: #fce8e6;
    border-color: #ffa8a8;
    color: #991b1b;
}

/* Tool usage styling */
.tool-usage-content {
    background: rgba(102, 126, 234, 0.1);
    border-left: 4px solid #667eea;
    padding: 0.75rem;
    margin: 0.5rem 0;
    border-radius: 0.5rem;
    font-style: italic;
    color: #5a67d8;
    font-weight: 500;
    position: relative;
}

.tool-usage-content::before {
    content: "🔧 ";
    font-style: normal;
    margin-right: 0.5rem;
}

.tool-usage-content p:first-child {
    margin-top: 0;
}

.tool-usage-content p:last-child {
    margin-bottom: 0;
}

/* Tool usage message styling */
.tool-usage-message .message-avatar i {
    color: #667eea;
}

.tool-usage-bubble {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    border: 1px solid rgba(102, 126, 234, 0.3);
    color: #5a67d8;
    font-style: italic;
    font-weight: 500;
    position: relative;
}

.tool-usage-bubble::before {
    content: "🔧 ";
    font-style: normal;
    margin-right: 0.5rem;
}

/* Markdown content styling */
.streaming-content h1,
.streaming-content h2,
.streaming-content h3 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.streaming-content h1 { font-size: 1.25rem; }
.streaming-content h2 { font-size: 1.125rem; }
.streaming-content h3 { font-size: 1rem; }

.streaming-content ul,
.streaming-content ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.streaming-content li {
    margin-bottom: 0.25rem;
}

.streaming-content strong {
    font-weight: 600;
    color: #2d3748;
}

.streaming-content em {
    font-style: italic;
}

.streaming-content code {
    background: #f7fafc;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
}

.streaming-content pre {
    background: #f7fafc;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 0.5rem 0;
}

.streaming-content blockquote {
    border-left: 4px solid #e2e8f0;
    padding-left: 1rem;
    margin: 0.5rem 0;
    font-style: italic;
    color: #718096;
}

/* Table styling for markdown content */
.streaming-content table,
.message-bubble table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
    font-size: 0.875rem;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.streaming-content table thead,
.message-bubble table thead {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.streaming-content table th,
.message-bubble table th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #e2e8f0;
}

.streaming-content table td,
.message-bubble table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
}

.streaming-content table tbody tr:hover,
.message-bubble table tbody tr:hover {
    background-color: #f8fafc;
}

.streaming-content table tbody tr:nth-child(even),
.message-bubble table tbody tr:nth-child(even) {
    background-color: #f9fafb;
}

.streaming-content table tbody tr:nth-child(even):hover,
.message-bubble table tbody tr:nth-child(even):hover {
    background-color: #f1f5f9;
}

/* Responsive table */
@media (max-width: 768px) {
    .streaming-content table,
    .message-bubble table {
        font-size: 0.75rem;
    }
    
    .streaming-content table th,
    .streaming-content table td,
    .message-bubble table th,
    .message-bubble table td {
        padding: 0.5rem;
    }
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes typing {
    0%, 60%, 100% { 
        transform: translateY(0);
        opacity: 0.5;
    }
    30% { 
        transform: translateY(-10px);
        opacity: 1;
    }
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
    100% {
        transform: scale(1);
    }
}

/* Source links styling */
.source-links-container {
    margin-top: 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 1rem;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    overflow: hidden;
}

.source-links-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
}

.source-links-header:hover {
    background: rgba(255, 255, 255, 0.5);
}

.source-links-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #4a5568;
    font-size: 0.9rem;
}

.source-links-toggle {
    font-size: 0.8rem;
    color: #6b7280;
    transition: transform 0.2s ease;
}

.source-links-toggle.expanded {
    transform: rotate(180deg);
}

.source-links-content {
    padding: 0 1rem 1rem 1rem;
    display: none;
    animation: slideDown 0.3s ease-out;
}

.source-links-content.show {
    display: block;
}

.source-link-item {
    display: inline-block;
    margin: 0.25rem 0.5rem 0.25rem 0;
    padding: 0.5rem 0.75rem;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    text-decoration: none;
    color: #374151;
    font-size: 0.85rem;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.source-link-item:hover {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    text-decoration: none;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.source-link-item i {
    margin-right: 0.4rem;
    font-size: 0.8rem;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Scrollbar styling */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f5f9;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

.tab-content {
    display: none;
    height: calc(100vh - 180px);
    flex-direction: column;
    margin-top: 1rem;
}

.tab-content.active {
    display: flex;
}

.mock-exam-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    background: #fafafa;
}

.exam-welcome {
    max-width: 500px;
    width: 100%;
}

.welcome-card {
    background: white;
    border-radius: 1.5rem;
    padding: 3rem 2rem;
    box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    text-align: center;
}

.exam-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    font-size: 2rem;
    color: white;
    box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
}

.exam-features {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin: 2rem 0;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 0.75rem;
    border: 1px solid #e2e8f0;
}

.feature-item i {
    font-size: 1.1rem;
    width: 20px;
    text-align: center;
}

.start-exam-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    padding: 1rem 2rem;
    border-radius: 2rem;
    font-weight: 600;
    box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.start-exam-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
    background: linear-gradient(135deg, #5a6fd8, #6a4190);
}

.exam-stats {
    display: flex;
    justify-content: space-around;
    padding-top: 2rem;
    border-top: 1px solid #e2e8f0;
}

.stat-item {
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: #667eea;
}

.stat-label {
    font-size: 0.8rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Mock Exam Question Interface */
.exam-question-interface {
    flex: 1;
    display: flex;
    padding: 2rem;
    background: #fafafa;
}

.question-container {
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.question-progress {
    font-size: 1.1rem;
    font-weight: 600;
    color: #667eea;
}

.question-topic {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-size: 0.9rem;
    font-weight: 500;
}

.question-card {
    background: white;
    border-radius: 1.5rem;
    padding: 2.5rem;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.question-text {
    font-size: 1.2rem;
    font-weight: 500;
    color: #2d3748;
    line-height: 1.6;
    margin-bottom: 2rem;
}

.question-options {
    display: grid;
    gap: 1rem;
}

.option-item {
    padding: 1rem 1.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.option-item:hover {
    border-color: #667eea;
    background: #f8fafc;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
}

.option-item.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
}

.option-item.correct {
    border-color: #10b981;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
}

.option-item.incorrect {
    border-color: #ef4444;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
}

.option-letter {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
    color: #64748b;
    flex-shrink: 0;
}

.option-item.selected .option-letter {
    background: #667eea;
    color: white;
}

.option-item.correct .option-letter {
    background: #10b981;
    color: white;
}

.option-item.incorrect .option-letter {
    background: #ef4444;
    color: white;
}

.option-text {
    flex: 1;
    font-size: 1rem;
    line-height: 1.5;
}

.question-feedback {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #e2e8f0;
}

.feedback-result {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    font-weight: 600;
}

.feedback-result.correct {
    color: #10b981;
}

.feedback-result.incorrect {
    color: #ef4444;
}

.correct-answer {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f0f9f4;
    border-left: 4px solid #10b981;
    border-radius: 0.5rem;
    font-weight: 500;
}

.show-explanation-btn {
    margin-bottom: 1rem;
}

.explanation-content {
    padding: 1.5rem;
    background: #f8fafc;
    border-radius: 1rem;
    border: 1px solid #e2e8f0;
    margin-top: 1rem;
}

.question-navigation {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

.question-navigation .btn {
    min-width: 120px;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .chat-container {
        border-radius: 0;
        height: 100vh;
    }
    
    .message-content {
        max-width: 85%;
    }
    
    .exam-features {
        grid-template-columns: 1fr;
    }
    
    .welcome-card {
        padding: 2rem 1.5rem;
    }
    
    .tab-btn {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
    }
    
    .chat-header {
        padding: 1rem;
    }
    
    .chat-title {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid h-100 p-0">
    <div class="chat-container">
        <!-- Modern Chat Header with Tabs -->
        <div class="chat-header">
            <div class="mb-3">
                <div>
                    <h1 class="chat-title">
                        <i class="fas fa-graduation-cap"></i>
                        SEBI Vidyalaya
                    </h1>
                    <p class="chat-subtitle">{{ exam_title }} • Instant Doubt Resolution • Adaptive Learning</p>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" id="aiTutorTab" onclick="switchTab('aiTutor')">
                    <i class="fas fa-robot"></i>
                    AI Tutor
                </button>
                <button class="tab-btn" id="mockExamTab" onclick="switchTab('mockExam')">
                    <i class="fas fa-clipboard-list"></i>
                    Mock Exam
                </button>
            </div>
        </div>

        <!-- AI Tutor Content -->
        <div class="tab-content active" id="aiTutorContent">
            <div class="chat-messages" id="chatMessages">
            <!-- Welcome Message -->
            <div class="message message-ai">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="mb-3">
                            <strong>👋 Welcome to your AI-powered SEBI tutor!</strong>
                        </div>
                        <div class="mb-2">I'm here to help you with <strong>{{ exam_title }}</strong>. Here's how I can assist:</div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center gap-2 p-2 bg-light rounded">
                                    <i class="fas fa-comments text-primary"></i>
                                    <small>Ask questions</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center gap-2 p-2 bg-light rounded">
                                    <i class="fas fa-image text-success"></i>
                                    <small>Upload images</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center gap-2 p-2 bg-light rounded">
                                    <i class="fas fa-microphone text-info"></i>
                                    <small>Voice input</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="fas fa-book text-warning"></i>
                                <strong>Please find your study materials here:</strong>
                            </div>
                            <div class="study-materials" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #667eea;">
                                <div id="studyMaterialsList">
                                    <!-- Study materials will be populated based on exam type -->
                                    {% if exam_type == 'investor_awareness' %}
                                        <div class="mb-2">
                                            <i class="fas fa-file-pdf text-danger me-2"></i>
                                            <a href="{{ url_for('static', filename='files/SEBI-Investor-Awareness-Test-FAQ.pdf') }}" target="_blank" class="text-decoration-none">
                                                SEBI Investor Awareness Test FAQ
                                            </a>
                                        </div>
                                        <div class="mb-2">
                                            <i class="fas fa-file-pdf text-danger me-2"></i>
                                            <a href="{{ url_for('static', filename='files/SEBI_-_Investor_Certification_Examination_-_Financial_Education_Booklet_30092024170623.pdf') }}" target="_blank" class="text-decoration-none">
                                                Financial Education Booklet
                                            </a>
                                        </div>
                                        <div class="mb-2">
                                            <i class="fas fa-file-pdf text-danger me-2"></i>
                                            <a href="{{ url_for('static', filename='files/SEBI_-_Investor_Certification_Examination_-_Securities_Market_Booklet_30092024170647.pdf') }}" target="_blank" class="text-decoration-none">
                                                Securities Market Booklet
                                            </a>
                                        </div>
                                        <div class="mb-2">
                                            <i class="fas fa-file-pdf text-danger me-2"></i>
                                            <a href="{{ url_for('static', filename='files/reading-mat-eng.pdf') }}" target="_blank" class="text-decoration-none">
                                                SEBI Investor Awareness Workshop
                                            </a>
                                        </div>
                                    {% elif exam_type == 'mf_foundation' %}
                                        <div class="mb-2">
                                            <i class="fas fa-file-pdf text-danger me-2"></i>
                                            <a href="{{ url_for('static', filename='files/NISM SERIES V-B MFF Workbook 2025 May 2025.pdf') }}" target="_blank" class="text-decoration-none">
                                                NISM Series V-B MFF Workbook 2025
                                            </a>
                                        </div>
                                    {% elif exam_type == 'invest_advisor' %}
                                        <div class="mb-2">
                                            <i class="fas fa-file-pdf text-danger me-2"></i>
                                            <a href="{{ url_for('static', filename='files/NISM Series X-A-Investment Adviser Level 1 - June 2025 version.pdf') }}" target="_blank" class="text-decoration-none">
                                                NISM Series X-A Investment Adviser Level 1
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="mt-3 p-2 bg-light rounded" style="border-left: 3px solid #28a745;">
                                    <small class="text-success">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>💡 Study Smart:</strong> Go through these materials at your own pace and feel free to ask me about any topics, concepts, or doubts you encounter. I'm here to help clarify complex ideas and make your learning journey easier!
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <small class="text-muted">Start by asking a question or uploading a document!</small>
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
        </div>

            <!-- Modern Input Area -->
            <div class="chat-input-container">
            <!-- Status Indicators -->
            <div id="voiceStatus" class="status-indicator d-none">
                <i class="fas fa-microphone fa-pulse"></i>
                <span id="voiceStatusText">Listening... Speak clearly</span>
                <button class="btn btn-sm btn-outline-danger ms-auto" onclick="stopRecording()">
                    <i class="fas fa-stop"></i> Stop
                </button>
            </div>
            <div id="transcriptionPreview" class="small text-muted mb-2"></div>

            <!-- Input Wrapper -->
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Ask me anything about SEBI regulations, investment concepts, or upload an image..."
                    onkeypress="handleKeyPress(event)"
                    rows="1"></textarea>
                
                <div class="input-actions">
                    <label for="fileInput" class="action-btn attach-btn" title="Upload Image">
                        <i class="fas fa-paperclip"></i>
                    </label>
                    <input type="file" id="fileInput" class="d-none" accept=".png,.jpg,.jpeg">
                    
                    <button class="action-btn voice-btn" id="voiceBtn" onclick="toggleRecording()" title="Voice Input">
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <button class="action-btn send-btn" onclick="sendMessage()" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="d-flex gap-2 mt-3 flex-wrap">
                <button class="btn btn-sm btn-outline-secondary" onclick="askFollowUp()">
                    <i class="fas fa-plus me-1"></i> Follow-up
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">
                    <i class="fas fa-eraser me-1"></i> Clear Chat
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="readAloud()">
                    <i class="fas fa-volume-up me-1"></i> Read Aloud
                </button>
            </div>
            </div>
        </div>
        
        <!-- Mock Exam Content -->
        <div class="tab-content" id="mockExamContent">
            <div class="mock-exam-container">
                <!-- Welcome Screen -->
                <div class="exam-welcome" id="examWelcome">
                    <div class="welcome-card">
                        <div class="text-center mb-4">
                            <div class="exam-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <h3>Mock Exam Practice</h3>
                            <p class="text-muted">Test your knowledge with practice questions</p>
                        </div>
                        
                        <div class="exam-features mb-4">
                            <div class="feature-item">
                                <i class="fas fa-clock text-info"></i>
                                <span>Adaptive Questions</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle text-success"></i>
                                <span>Instant Feedback</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-book text-warning"></i>
                                <span>Detailed Explanations</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-chart-line text-primary"></i>
                                <span>Progress Tracking</span>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button class="btn btn-primary btn-lg start-exam-btn" onclick="startMockExam()">
                                <i class="fas fa-play me-2"></i>
                                Start Mock Exam
                            </button>
                        </div>
                        
                        <div class="exam-stats mt-4">
                            <div class="stat-item">
                                <span class="stat-value" id="totalQuestions">20</span>
                                <span class="stat-label">Questions</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="completedExams">0</span>
                                <span class="stat-label">Completed</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="bestScore">--</span>
                                <span class="stat-label">Best Score</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Question Interface -->
                <div class="exam-question-interface" id="examQuestionInterface" style="display: none;">
                    <div class="question-container">
                        <div class="question-header">
                            <div class="question-progress">
                                <span id="questionNumber">1</span> of <span id="totalQuestionsDisplay">20</span>
                            </div>
                            <div class="question-topic">
                                <span id="questionTopic">Loading...</span>
                            </div>
                        </div>
                        
                        <div class="question-card">
                            <div class="question-text" id="questionText">
                                Loading question...
                            </div>
                            
                            <div class="question-options" id="questionOptions">
                                <!-- Options will be populated dynamically -->
                            </div>
                            
                            <!-- Feedback Section (hidden initially) -->
                            <div class="question-feedback" id="questionFeedback" style="display: none;">
                                <div class="feedback-result" id="feedbackResult">
                                    <!-- Correct/Incorrect message -->
                                </div>
                                <div class="correct-answer" id="correctAnswer">
                                    <!-- Correct answer display -->
                                </div>
                                <button class="btn btn-outline-info show-explanation-btn" id="showExplanationBtn" onclick="showExplanation()">
                                    <i class="fas fa-book me-1"></i>
                                    Show Explanation
                                </button>
                                <div class="explanation-content" id="explanationContent" style="display: none;">
                                    <!-- Explanation will be streamed here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="question-navigation">
                            <button class="btn btn-outline-secondary" id="prevBtn" onclick="previousQuestion()" disabled>
                                <i class="fas fa-chevron-left me-1"></i>
                                Previous
                            </button>
                            <button class="btn btn-primary" id="submitBtn" onclick="submitAnswer()" disabled>
                                Submit Answer
                            </button>
                            <button class="btn btn-outline-secondary" id="nextBtn" onclick="nextQuestion()" disabled>
                                Next
                                <i class="fas fa-chevron-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient border-0">
                <h5 class="modal-title fw-600">
                    <i class="fas fa-image me-2 text-primary"></i>
                    Image Preview
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center">
                    <img id="previewImage" class="img-fluid rounded-3 shadow-sm" src="" alt="Preview" style="max-height: 400px;">
                    <div class="mt-3">
                        <span id="fileName" class="badge bg-primary px-3 py-2 fs-6"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmImageUpload()">
                    <i class="fas fa-check me-1"></i> Add to Chat
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/speech.js') }}"></script>
<script>
// Global variables
const examType = "{{ exam_type }}";
let currentImageData = null;
let isRecording = false;
let mediaRecorder = null;
let audioStream = null;
let audioChunks = [];
let chatHistory = [];
let currentTab = 'aiTutor';
let mockExamData = {
    questions: [],
    currentQuestion: 0,
    answers: [],
    messages: [],
    startTime: null,
    endTime: null,
    isExamActive: false,
    currentQuestionData: null,
    selectedAnswer: null,
    explanations: {} // Store explanations by question number
};

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeFileUpload();
    scrollToBottom();
    
    // Always set language to English when opening chat interface
    localStorage.setItem('selectedLanguage', 'en-US');
    
    // Update navbar to show current language
    updateCurrentLanguageDisplay();
});


function initializeFileUpload() {
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', handleFileSelect);
    
    // Drag and drop functionality
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.addEventListener('dragover', handleDragOver);
    chatMessages.addEventListener('drop', handleFileDrop);
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message && !currentImageData) {
        return;
    }
    
    // Disable send button temporarily
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    
    // Create user message object
    let userMessage;
    if (currentImageData) {
        const contentArray = [];
        
        // Add text content if message exists
        if (message && message.trim()) {
            contentArray.push({
                'type': 'text',
                'text': message
            });
        }
        
        // Add image content
        contentArray.push({
            'type': 'image_url',
            'image_url': {
                'url': currentImageData.base64
            }
        });
        
        userMessage = {
            'role': 'user',
            'content': contentArray
        };
    } else {
        userMessage = {
            'role': 'user',
            'content': message
        };
    }
    
    // Add user message to chat history
    chatHistory.push(userMessage);
    
    // Display user message immediately
    displayMessage({
        id: Date.now(),
        type: 'user',
        content: userMessage.content,
        timestamp: new Date().toISOString()
    });
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send chat history to backend with SSE streaming
    handleStreamingResponse({
        exam_type: examType,
        chat_history: chatHistory,
        language: getCurrentLanguage()
    }, sendBtn);
    
    // Clear input and image data
    messageInput.value = '';
    messageInput.placeholder = 'Type your question here...';
    currentImageData = null;
}

function handleStreamingResponse(requestData, sendBtn) {
    let currentAiMessage = null;
    let aiMessageContent = '';
    
    fetch('/send_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        function processStream() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    hideTypingIndicator();
                    sendBtn.disabled = false;
                    
                    // Add final AI response to chat history
                    if (aiMessageContent) {
                        chatHistory.push({
                            'role': 'assistant',
                            'content': aiMessageContent
                        });
                    }
                    return;
                }
                
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        
                        if (data === '[DONE]') {
                            hideTypingIndicator();
                            sendBtn.disabled = false;
                            if (aiMessageContent) {
                                chatHistory.push({
                                    'role': 'assistant',
                                    'content': aiMessageContent
                                });
                            }
                            return;
                        }
                        
                        try {
                            const parsed = JSON.parse(data);
                            
                            if (parsed.type === 'content' || parsed.type === 'final_content') {
                                hideTypingIndicator();
                                
                                // Create AI message if it doesn't exist
                                if (!currentAiMessage) {
                                    currentAiMessage = createStreamingMessage();
                                }
                                
                                // Append content to the streaming message
                                aiMessageContent += parsed.content;
                                updateStreamingMessage(currentAiMessage, aiMessageContent);
                                scrollToBottom();
                                
                            } else if (parsed.type === 'tool_usage') {
                                // Show tool usage indicator immediately as separate message
                                hideTypingIndicator();
                                displayToolUsageMessage(parsed.content.replace(/\\n/g, '\n'));
                                scrollToBottom();
                                
                            } else if (parsed.type === 'newline') {
                                if (currentAiMessage) {
                                    // Replace \n with actual line breaks
                                    const newlineContent = parsed.content.replace(/\\n/g, '\n');
                                    aiMessageContent += newlineContent;
                                    updateStreamingMessage(currentAiMessage, aiMessageContent);
                                    scrollToBottom();
                                }
                                
                            } else if (parsed.type === 'source') {
                                // Handle source information display
                                if (parsed.content && parsed.content.length > 0) {
                                    displaySourceLinks(parsed.content);
                                }
                                
                            } else if (parsed.type === 'error') {
                                hideTypingIndicator();
                                showError(parsed.content);
                                sendBtn.disabled = false;
                                return;
                            }
                        } catch (e) {
                            console.error('Error parsing SSE data:', e, data);
                        }
                    }
                }
                
                return processStream();
            });
        }
        
        return processStream();
    })
    .catch(error => {
        console.error('Streaming error:', error);
        hideTypingIndicator();
        showError('Failed to send message');
        sendBtn.disabled = false;
    });
}

function createStreamingMessage() {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message message-ai';
    messageDiv.id = 'streamingMessage';
    
    const time = new Date().toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                <div class="streaming-content"></div>
            </div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    return messageDiv;
}

function updateStreamingMessage(messageElement, content, isToolUsage = false) {
    const contentDiv = messageElement.querySelector('.streaming-content');
    if (contentDiv) {
        // Preserve line breaks and parse markdown
        const processedContent = content.replace(/\n/g, '\n\n'); // Double newlines for markdown paragraph breaks
        const htmlContent = marked.parse(processedContent);
        contentDiv.innerHTML = htmlContent;
        
        // Add special styling for tool usage messages
        if (isToolUsage) {
            contentDiv.classList.add('tool-usage-content');
        }
    }
}

function displayToolUsageMessage(content) {
    const chatMessages = document.getElementById('chatMessages');
    const toolMessageDiv = document.createElement('div');
    toolMessageDiv.className = 'message message-ai tool-usage-message';
    
    const time = new Date().toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    toolMessageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-cog fa-spin"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble tool-usage-bubble">
                ${content}
            </div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    chatMessages.appendChild(toolMessageDiv);
}

function displaySourceLinks(sources) {
    if (!sources || sources.length === 0) return;
    
    const chatMessages = document.getElementById('chatMessages');
    const lastAiMessage = chatMessages.querySelector('.message-ai:last-child');
    
    if (lastAiMessage) {
        // Check if sources already exist for this message
        const existingSources = lastAiMessage.querySelector('.source-links-container');
        if (existingSources) {
            existingSources.remove(); // Remove existing to replace
        }
        
        const sourceDiv = document.createElement('div');
        sourceDiv.className = 'source-links-container';
        
        // Generate unique ID for this source container
        const sourceId = 'sources-' + Date.now();
        
        let sourceLinksHtml = `
            <div class="source-links-header" onclick="toggleSources('${sourceId}')">
                <div class="source-links-title">
                    <i class="fas fa-book-open"></i>
                    <span>Study Material References (${sources.length})</span>
                </div>
                <i class="fas fa-chevron-down source-links-toggle" id="${sourceId}-toggle"></i>
            </div>
            <div class="source-links-content" id="${sourceId}-content">
        `;
        
        // Group sources by document name to avoid duplicates
        const uniqueSources = {};
        sources.forEach(source => {
            const key = `${source.document_name}_${source.page_number}`;
            if (!uniqueSources[key]) {
                uniqueSources[key] = source;
            }
        });
        
        Object.values(uniqueSources).forEach(source => {
            const fileName = source.document_name || 'Unknown Document';
            const pageNum = source.page_number || 1;
            
            // Create PDF link with page parameter
            const pdfUrl = `/static/files/${fileName}#page=${pageNum}`;
            
            sourceLinksHtml += `
                <a href="${pdfUrl}" 
                   target="_blank" 
                   class="source-link-item"
                   title="Open ${fileName} at page ${pageNum}">
                    <i class="fas fa-file-pdf"></i>
                    ${fileName.replace('.pdf', '')}, page: ${pageNum}
                </a>
            `;
        });
        
        sourceLinksHtml += '</div>';
        sourceDiv.innerHTML = sourceLinksHtml;
        
        // Append to the message content
        const messageContent = lastAiMessage.querySelector('.message-content');
        messageContent.appendChild(sourceDiv);
        
        scrollToBottom();
    }
}

function displayMessage(messageData) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${messageData.type}`;
    
    const time = new Date(messageData.timestamp).toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Handle different content formats
    let contentHtml = '';
    if (Array.isArray(messageData.content)) {
        // New format: content is array with text and image_url objects
        messageData.content.forEach(item => {
            if (item.type === 'text') {
                contentHtml += `<div class="mb-2">${item.text}</div>`;
            } else if (item.type === 'image_url') {
                contentHtml += `
                    <div class="mb-3">
                        <img src="${item.image_url.url}" class="img-fluid rounded-3 shadow-sm" style="max-width: 280px;" alt="Uploaded image">
                    </div>
                `;
            }
        });
    } else {
        // Simple text content - parse markdown for AI messages
        if (messageData.type === 'ai') {
            const processedContent = messageData.content.replace(/\n/g, '\n\n');
            contentHtml = marked.parse(processedContent);
        } else {
            contentHtml = messageData.content;
        }
    }
    
    // Modern message structure matching the welcome message
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-${messageData.type === 'user' ? 'user' : 'robot'}"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                ${contentHtml}
            </div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message message-ai';
    typingDiv.id = 'typingIndicator';
    
    typingDiv.innerHTML = `
        <div class="message-header">
            <i class="fas fa-robot me-1"></i> AI Tutor
        </div>
        <div class="typing-indicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    scrollToBottom();
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertBefore(alert, document.querySelector('.chat-container'));
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// File upload functions
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        previewImage(file);
    }
}

function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'copy';
}

function handleFileDrop(event) {
    event.preventDefault();
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        previewImage(files[0]);
    }
}

function previewImage(file) {
    if (file.size > 5 * 1024 * 1024) {
        showError('File too large. Please upload images under 5MB.');
        return;
    }
    
    // Validate file type
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];
    if (!allowedTypes.includes(file.type)) {
        showError('Please upload PNG, JPG, or JPEG images only.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('previewImage').src = e.target.result;
        document.getElementById('fileName').textContent = file.name;
        
        // Store image data for sending
        currentImageData = {
            base64: e.target.result,
            filename: file.name,
            type: file.type
        };
        
        new bootstrap.Modal(document.getElementById('imagePreviewModal')).show();
    };
    reader.readAsDataURL(file);
}

function confirmImageUpload() {
    if (!currentImageData) return;
    
    // Update message input placeholder
    document.getElementById('messageInput').placeholder = `Image selected: ${currentImageData.filename}. Type your question...`;
    
    // Hide modal
    bootstrap.Modal.getInstance(document.getElementById('imagePreviewModal')).hide();
    
    // Focus on message input
    document.getElementById('messageInput').focus();
}


// Voice functions
function toggleRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

async function startRecording() {
    try {
        // Get user media
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create MediaRecorder
        mediaRecorder = new MediaRecorder(audioStream, {
            mimeType: 'audio/webm;codecs=opus'
        });
        
        audioChunks = [];
        
        mediaRecorder.ondataavailable = function(event) {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
                // Send audio chunk for real-time transcription
                sendAudioChunkForTranscription(event.data);
            }
        };
        
        mediaRecorder.onstop = function() {
            // Final transcription when recording stops
            if (audioChunks.length > 0) {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                sendFinalAudioForTranscription(audioBlob);
            }
        };
        
        // Start recording
        isRecording = true;
        updateVoiceButton();
        showVoiceStatus();
        
        // Start recording with chunks every 1 second for real-time processing
        mediaRecorder.start(1000);
        
    } catch (error) {
        console.error('Error starting recording:', error);
        showError('Microphone access denied or not available.');
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    
    if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
    }
    
    isRecording = false;
    updateVoiceButton();
    hideVoiceStatus();
}

function updateVoiceButton() {
    const voiceBtn = document.getElementById('voiceBtn');
    const icon = voiceBtn.querySelector('i');
    
    if (isRecording) {
        voiceBtn.classList.add('btn-danger');
        voiceBtn.classList.remove('btn-outline-sebi-navy');
        icon.className = 'fas fa-stop';
    } else {
        voiceBtn.classList.remove('btn-danger');
        voiceBtn.classList.add('btn-outline-sebi-navy');
        icon.className = 'fas fa-microphone';
    }
}

function showVoiceStatus() {
    document.getElementById('voiceStatus').classList.remove('d-none');
}

function hideVoiceStatus() {
    document.getElementById('voiceStatus').classList.add('d-none');
    document.getElementById('transcriptionPreview').textContent = '';
}

function getCurrentLanguage() {
    const lang = localStorage.getItem('selectedLanguage') || 'en-US';
    console.log('Current language:', lang); // Debug logging
    return lang;
}

function updateCurrentLanguageDisplay() {
    const lang = getCurrentLanguage();
    const langNames = {
        'en-US': 'English',
        'hi-IN': 'हिन्दी', 
        'bn-IN': 'বাংলা',
        'mr-IN': 'मराठी',
        'kn-IN': 'ಕನ್ನಡ',
        'gu-IN': 'ગુજરાતી'
    };
    
    const currentLangElement = document.getElementById('current-language');
    if (currentLangElement) {
        currentLangElement.textContent = langNames[lang] || 'English';
    }
}

// New functions for Google Cloud Speech API
async function sendAudioChunkForTranscription(audioBlob) {
    try {
        const currentLang = getCurrentLanguage();
        console.log('Sending audio chunk:', {
            blobSize: audioBlob.size,
            blobType: audioBlob.type,
            language: currentLang,
            streaming: true
        });
        
        const formData = new FormData();
        formData.append('audio_data', audioBlob);
        formData.append('language', currentLang);
        formData.append('streaming', 'true');
        
        const response = await fetch('/transcribe', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        console.log('Transcription result:', result);
        
        if (result.success && result.transcript) {
            // Update transcription preview with interim results
            document.getElementById('transcriptionPreview').textContent = result.transcript;
        }
    } catch (error) {
        console.error('Real-time transcription error:', error);
    }
}

async function sendFinalAudioForTranscription(audioBlob) {
    try {
        const currentLang = getCurrentLanguage();
        console.log('Sending final audio:', {
            blobSize: audioBlob.size,
            blobType: audioBlob.type,
            language: currentLang,
            streaming: false
        });
        
        const formData = new FormData();
        formData.append('audio_data', audioBlob);
        formData.append('language', currentLang);
        formData.append('streaming', 'false');
        
        const response = await fetch('/transcribe', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        console.log('Final transcription result:', result);
        
        if (result.success && result.transcript) {
            // Set final transcript in input box
            document.getElementById('messageInput').value = result.transcript;
            document.getElementById('transcriptionPreview').textContent = '';
        } else {
            console.error('Transcription failed:', result.error || 'No transcript returned');
        }
    } catch (error) {
        console.error('Final transcription error:', error);
        showError('Transcription failed. Please try again.');
    }
}

// Language functions with multilingual welcome messages
const welcomeMessages = {
    'en-US': {
        title: '👋 Welcome to your AI-powered SEBI tutor!',
        subtitle: 'Here\'s how I can assist:',
        features: {
            questions: 'Ask questions',
            images: 'Upload images', 
            voice: 'Voice input'
        },
        studyMaterials: 'Please find your study materials here:',
        encouragement: '💡 Study Smart: Go through these materials at your own pace and feel free to ask me about any topics, concepts, or doubts you encounter. I\'m here to help clarify complex ideas and make your learning journey easier!',
        cta: 'Start by asking a question or uploading a document!'
    },
    'hi-IN': {
        title: '👋 आपके AI-संचालित SEBI ट्यूटर में आपका स्वागत है!',
        subtitle: 'मैं इस तरह आपकी सहायता कर सकता हूं:',
        features: {
            questions: 'प्रश्न पूछें',
            images: 'छवियां अपलोड करें',
            voice: 'आवाज इनपुट'
        },
        studyMaterials: 'कृपया यहाँ अपनी अध्ययन सामग्री देखें:',
        encouragement: '💡 स्मार्ट पढ़ाई: इन सामग्रियों को अपनी गति से पढ़ें और किसी भी विषय, अवधारणा या संदेह के बारे में बेझिझक पूछें। मैं जटिल विचारों को स्पष्ट करने और आपकी सीखने की यात्रा को आसान बनाने में आपकी मदद करने के लिए यहाँ हूँ!',
        cta: 'कोई प्रश्न पूछकर या दस्तावेज़ अपलोड करके शुरू करें!'
    },
    'bn-IN': {
        title: '👋 আপনার AI-চালিত SEBI টিউটরে স্বাগতম!',
        subtitle: 'আমি কীভাবে আপনাকে সাহায্য করতে পারি:',
        features: {
            questions: 'প্রশ্ন করুন',
            images: 'ছবি আপলোড করুন',
            voice: 'ভয়েস ইনপুট'
        },
        studyMaterials: 'অনুগ্রহ করে এখানে আপনার অধ্যয়ন উপকরণ দেখুন:',
        encouragement: '💡 স্মার্ট পড়াশোনা: এই উপকরণগুলো আপনার নিজের গতিতে পড়ুন এবং যেকোনো বিষয়, ধারণা বা সন্দেহ নিয়ে নির্দ্বিধায় আমাকে জিজ্ঞেস করুন। জটিল বিষয়গুলো পরিষ্কার করতে এবং আপনার শেখার যাত্রা সহজ করতে আমি এখানে আছি!',
        cta: 'একটি প্রশ্ন জিজ্ঞেস করে বা একটি নথি আপলোড করে শুরু করুন!'
    },
    'mr-IN': {
        title: '👋 तुमच्या AI-चालित SEBI ट्यूटरमध्ये तुमचे स्वागत आहे!',
        subtitle: 'मी तुम्हाला कसे मदत करू शकतो:',
        features: {
            questions: 'प्रश्न विचारा',
            images: 'प्रतिमा अपलोड करा',
            voice: 'आवाज इनपुट'
        },
        studyMaterials: 'कृपया येथे तुमची अभ्यास सामग्री पहा:',
        encouragement: '💡 स्मार्ट अभ्यास: ही सामग्री तुमच्या गतीने वाचा आणि कोणत्याही विषयाबद्दल, संकल्पनेबद्दल किंवा शंकांबद्दल मला निसंकोचपणे विचारा। जटिल कल्पना स्पष्ट करण्यासाठी आणि तुमचा शिक्षणाचा प्रवास सोपा करण्यासाठी मी येथे आहे!',
        cta: 'प्रश्न विचारून किंवा दस्तऐवज अपलोड करून सुरुवात करा!'
    },
    'kn-IN': {
        title: '👋 ನಿಮ್ಮ AI-ಚಾಲಿತ SEBI ಟ್ಯೂಟರ್‌ಗೆ ಸುಸ್ವಾಗತ!',
        subtitle: 'ನಾನು ಹೇಗೆ ಸಹಾಯ ಮಾಡಬಹುದು:',
        features: {
            questions: 'ಪ್ರಶ್ನೆಗಳನ್ನು ಕೇಳಿ',
            images: 'ಚಿತ್ರಗಳನ್ನು ಅಪ್‌ಲೋಡ್ ಮಾಡಿ',
            voice: 'ಧ್ವನಿ ಇನ್‌ಪುಟ್'
        },
        studyMaterials: 'ದಯವಿಟ್ಟು ಇಲ್ಲಿ ನಿಮ್ಮ ಅಧ್ಯಯನ ಸಾಮಗ್ರಿಗಳನ್ನು ನೋಡಿ:',
        encouragement: '💡 ಸ್ಮಾರ್ಟ್ ಅಧ್ಯಯನ: ಈ ಸಾಮಗ್ರಿಗಳನ್ನು ನಿಮ್ಮ ವೇಗದಲ್ಲಿ ಅಧ್ಯಯನ ಮಾಡಿ ಮತ್ತು ಯಾವುದೇ ವಿಷಯಗಳು, ಪರಿಕಲ್ಪನೆಗಳು ಅಥವಾ ಅನುಮಾನಗಳ ಬಗ್ಗೆ ನಿರ್ದ್ವಿಧೆಯಿಂದ ನನ್ನನ್ನು ಕೇಳಿ। ಸಂಕೀರ್ಣ ವಿಚಾರಗಳನ್ನು ಸ್ಪಷ್ಟಪಡಿಸಲು ಮತ್ತು ನಿಮ್ಮ ಕಲಿಕೆಯ ಪ್ರಯಾಣವನ್ನು ಸುಲಭಗೊಳಿಸಲು ನಾನು ಇಲ್ಲಿದ್ದೇನೆ!',
        cta: 'ಪ್ರಶ್ನೆ ಕೇಳುವ ಮೂಲಕ ಅಥವಾ ದಾಖಲೆ ಅಪ್‌ಲೋಡ್ ಮಾಡುವ ಮೂಲಕ ಪ್ರಾರಂಭಿಸಿ!'
    },
    'gu-IN': {
        title: '👋 તમારા AI-સંચાલિત SEBI ટ્યૂટરમાં આપનું સ્વાગત છે!',
        subtitle: 'હું કેવી રીતે મદદ કરી શકું:',
        features: {
            questions: 'પ્રશ્નો પૂછો',
            images: 'છબીઓ અપલોડ કરો',
            voice: 'વૉઇસ ઇનપુટ'
        },
        studyMaterials: 'કૃપા કરીને અહીં તમારી અધ્યયયન સામગ્રી જુઓ:',
        encouragement: '💡 સ્માર્ટ અભ્યાસ: આ સામગ્રીઓ તમારી ગતિએ વાંચો અને કોઈપણ વિષયો, વિભાવનાઓ કે શંકાઓ વિશે નિઃસંકોચ મને પૂછો। જટિલ વિચારોને સ્પષ્ટ કરવા અને તમારી શીખવાની યાત્રાને સરળ બનાવવા માટે હું અહીં છું!',
        cta: 'પ્રશ્ન પૂછીને અથવા દસ્તાવેજ અપલોડ કરીને શરૂ કરો!'
    }
};

function changeLanguage(langCode, langName) {
    // Store language preference locally
    localStorage.setItem('selectedLanguage', langCode);
    document.getElementById('current-language').textContent = langName;
    
    // Clear current chat and show new welcome message
    resetChatWithLanguage(langCode);
}

function getStudyMaterialsHtml() {
    // Get the exam type from the global variable or URL
    const currentExamType = examType || 'default';
    
    if (currentExamType === 'investor_awareness') {
        return `
            <div class="mb-2">
                <i class="fas fa-file-pdf text-danger me-2"></i>
                <a href="/static/files/SEBI-Investor-Awareness-Test-FAQ.pdf" target="_blank" class="text-decoration-none">
                    SEBI Investor Awareness Test FAQ
                </a>
            </div>
            <div class="mb-2">
                <i class="fas fa-file-pdf text-danger me-2"></i>
                <a href="/static/files/SEBI_-_Investor_Certification_Examination_-_Financial_Education_Booklet_30092024170623.pdf" target="_blank" class="text-decoration-none">
                    Financial Education Booklet
                </a>
            </div>
            <div class="mb-2">
                <i class="fas fa-file-pdf text-danger me-2"></i>
                <a href="/static/files/SEBI_-_Investor_Certification_Examination_-_Securities_Market_Booklet_30092024170647.pdf" target="_blank" class="text-decoration-none">
                    Securities Market Booklet
                </a>
            </div>
            <div class="mb-2">
                <i class="fas fa-file-pdf text-danger me-2"></i>
                <a href="/static/files/reading-mat-eng.pdf" target="_blank" class="text-decoration-none">
                    SEBI Investor Awareness Workshop
                </a>
            </div>
        `;
    } else if (currentExamType === 'mf_foundation') {
        return `
            <div class="mb-2">
                <i class="fas fa-file-pdf text-danger me-2"></i>
                <a href="/static/files/NISM SERIES V-B MFF Workbook 2025 May 2025.pdf" target="_blank" class="text-decoration-none">
                    NISM Series V-B MFF Workbook 2025
                </a>
            </div>
        `;
    } else if (currentExamType === 'invest_advisor') {
        return `
            <div class="mb-2">
                <i class="fas fa-file-pdf text-danger me-2"></i>
                <a href="/static/files/NISM Series X-A-Investment Adviser Level 1 - June 2025 version.pdf" target="_blank" class="text-decoration-none">
                    NISM Series X-A Investment Adviser Level 1
                </a>
            </div>
        `;
    } else {
        return `
            <div class="mb-2">
                <i class="fas fa-file-pdf text-danger me-2"></i>
                <a href="/static/files/reading-mat-eng.pdf" target="_blank" class="text-decoration-none">
                    General Reading Material
                </a>
            </div>
        `;
    }
}

function resetChatWithLanguage(langCode) {
    // Clear chat messages but keep the structure
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    
    // Reset chat history
    chatHistory = [
        // {
        //     'role': 'system',
        //     'content': 'You are a helpful AI tutor for SEBI certification exam preparation.'
        // }
    ];
    
    // Get welcome message for the selected language
    const welcome = welcomeMessages[langCode] || welcomeMessages['en-US'];
    
    // Create new welcome message in selected language
    const welcomeDiv = document.createElement('div');
    welcomeDiv.className = 'message message-ai';
    
    welcomeDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                <div class="mb-3">
                    <strong>${welcome.title}</strong>
                </div>
                <div class="mb-2">${welcome.subtitle}</div>
                <div class="row g-2 mb-3">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center gap-2 p-2 bg-light rounded">
                            <i class="fas fa-comments text-primary"></i>
                            <small>${welcome.features.questions}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center gap-2 p-2 bg-light rounded">
                            <i class="fas fa-image text-success"></i>
                            <small>${welcome.features.images}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center gap-2 p-2 bg-light rounded">
                            <i class="fas fa-microphone text-info"></i>
                            <small>${welcome.features.voice}</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fas fa-book text-warning"></i>
                        <strong>${welcome.studyMaterials}</strong>
                    </div>
                    <div class="study-materials" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #667eea;">
                        <div id="studyMaterialsList">
                            ${getStudyMaterialsHtml()}
                        </div>
                        <div class="mt-3 p-2 bg-light rounded" style="border-left: 3px solid #28a745;">
                            <small class="text-success">
                                <i class="fas fa-lightbulb me-1"></i>
                                <strong>${welcome.encouragement}</strong>
                            </small>
                        </div>
                    </div>
                </div>
                
                <small class="text-muted">${welcome.cta}</small>
            </div>
            <div class="message-time">Just now</div>
        </div>
    `;
    
    chatMessages.appendChild(welcomeDiv);
    scrollToBottom();
}

// Quick action functions
function askFollowUp() {
    document.getElementById('messageInput').value = 'Can you explain this in more detail?';
    document.getElementById('messageInput').focus();
}

function takeNotes() {
    showError('Note-taking feature coming soon!');
}

function readAloud() {
    const lastAiMessage = document.querySelector('.message-ai:last-of-type .message-bubble');
    if (lastAiMessage && 'speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(lastAiMessage.textContent);
        utterance.lang = getCurrentLanguage().replace('-', '_');
        speechSynthesis.speak(utterance);
    } else {
        showError('Speech synthesis not available.');
    }
}

// Additional modern UI functions
function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    // Keep only the welcome message
    const welcomeMessage = chatMessages.querySelector('.message-ai');
    chatMessages.innerHTML = '';
    if (welcomeMessage) {
        chatMessages.appendChild(welcomeMessage);
    }
    
    // Reset chat history
    chatHistory = [];
}

function updateVoiceButton() {
    const voiceBtn = document.getElementById('voiceBtn');
    
    if (isRecording) {
        voiceBtn.classList.add('recording');
        voiceBtn.querySelector('i').className = 'fas fa-stop';
    } else {
        voiceBtn.classList.remove('recording');
        voiceBtn.querySelector('i').className = 'fas fa-microphone';
    }
}

function showVoiceStatus() {
    document.getElementById('voiceStatus').classList.remove('d-none');
}

function hideVoiceStatus() {
    document.getElementById('voiceStatus').classList.add('d-none');
    document.getElementById('transcriptionPreview').textContent = '';
}

// Tab switching functionality
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(tabName + 'Content').classList.add('active');
    
    currentTab = tabName;
    
    // Load exam stats if switching to mock exam
    if (tabName === 'mockExam') {
        loadExamStats();
    }
}

// Mock exam functionality
async function startMockExam() {
    try {
        // Hide welcome screen and show question interface
        document.getElementById('examWelcome').style.display = 'none';
        document.getElementById('examQuestionInterface').style.display = 'flex';
        
        // Initialize exam data
        mockExamData = {
            questions: [],
            currentQuestion: 1,
            answers: [],
            messages: [],
            startTime: new Date(),
            endTime: null,
            isExamActive: true,
            currentQuestionData: null,
            selectedAnswer: null,
            explanations: {} // Store explanations by question number
        };
        
        // Load first question
        await loadNextQuestion(true);
        
    } catch (error) {
        console.error('Error starting mock exam:', error);
        alert('Failed to start exam. Please try again.');
    }
}

async function loadNextQuestion(isInitial = false) {
    try {
        // Show loading state if not already shown
        if (!isInitial) {
            // Loading already shown by nextQuestion(), but show for initial load
        } else {
            showQuestionLoading();
        }
        
        const response = await fetch('/mock_exam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: mockExamData.messages,
                is_initial: isInitial,
                exam_type: examType
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const questionData = await response.json();
        
        // Store current question data
        mockExamData.currentQuestionData = questionData;
        mockExamData.selectedAnswer = null;
        
        // Display the question (this will clear loading state)
        displayQuestion(questionData);
        
    } catch (error) {
        console.error('Error loading question:', error);
        alert('Failed to load question. Please try again.');
        
        // Reset loading state on error
        document.getElementById('questionText').textContent = 'Failed to load question. Please try again.';
        document.getElementById('questionOptions').innerHTML = '<div class="text-center text-danger">Error loading question</div>';
        document.getElementById('questionTopic').textContent = 'Error';
    }
}

function displayQuestion(questionData) {
    // Update question number and topic
    document.getElementById('questionNumber').textContent = mockExamData.currentQuestion;
    document.getElementById('questionTopic').textContent = questionData.topic_name || 'General';
    
    // Display question text
    document.getElementById('questionText').textContent = questionData.question;
    
    // Create options
    const optionsContainer = document.getElementById('questionOptions');
    optionsContainer.innerHTML = '';
    
    // Handle options array format: [{"a": "option text"}, {"b": "option text"}, ...]
    questionData.options.forEach((optionObj) => {
        // Each option is an object with single key-value pair like {"a": "option text"}
        const optionLetter = Object.keys(optionObj)[0];
        const optionText = optionObj[optionLetter];
        
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option-item';
        optionDiv.onclick = () => selectOption(optionLetter, optionDiv);
        optionDiv.setAttribute('data-option', optionLetter);
        
        optionDiv.innerHTML = `
            <div class="option-letter">${optionLetter.toUpperCase()}</div>
            <div class="option-text">${optionText}</div>
        `;
        
        optionsContainer.appendChild(optionDiv);
    });
    
    // Reset feedback section
    document.getElementById('questionFeedback').style.display = 'none';
    document.getElementById('explanationContent').style.display = 'none';
    
    // Update navigation buttons
    updateNavigationButtons();
}

function selectOption(optionKey, optionElement) {
    // Ensure we store the option key as string (a, b, c, d)
    const selectedKey = String(optionKey).toLowerCase();
    
    // Remove previous selection
    document.querySelectorAll('.option-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Select current option
    optionElement.classList.add('selected');
    mockExamData.selectedAnswer = selectedKey;
    
    console.log('Selected Answer:', selectedKey, 'Type:', typeof selectedKey);
    
    // Enable submit button
    document.getElementById('submitBtn').disabled = false;
}

function submitAnswer() {
    if (!mockExamData.selectedAnswer || !mockExamData.currentQuestionData) {
        return;
    }
    
    const correctOption = String(mockExamData.currentQuestionData.correct_option).toLowerCase();
    const userAnswer = String(mockExamData.selectedAnswer).toLowerCase();
    const isCorrect = userAnswer === correctOption;
    
    // Debug logging
    console.log('Submit Answer Debug:', {
        userAnswer: userAnswer,
        userAnswerType: typeof userAnswer,
        correctOption: correctOption,
        correctOptionType: typeof correctOption,
        isCorrect: isCorrect
    });
    
    // Store the answer
    const answerData = {
        content: JSON.stringify({
            ...mockExamData.currentQuestionData,
            user_selected_option: userAnswer,
            is_correct: isCorrect,
            answered_at: new Date().toISOString()
        }),
        role: 'user'
    };
    
    mockExamData.messages.push(answerData);
    
    // Show visual feedback
    showAnswerFeedback(isCorrect, correctOption);
    
    // Update navigation
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('nextBtn').disabled = false;
}

function showAnswerFeedback(isCorrect, correctOption) {
    const feedbackDiv = document.getElementById('questionFeedback');
    const resultDiv = document.getElementById('feedbackResult');
    const correctAnswerDiv = document.getElementById('correctAnswer');
    
    // Show feedback section
    feedbackDiv.style.display = 'block';
    
    // Update result message
    resultDiv.className = `feedback-result ${isCorrect ? 'correct' : 'incorrect'}`;
    resultDiv.innerHTML = `
        <i class="fas fa-${isCorrect ? 'check-circle' : 'times-circle'}"></i>
        ${isCorrect ? 'Correct!' : 'Incorrect'}
    `;
    
    // Show correct answer if incorrect
    if (!isCorrect) {
        // Find the correct option text from the array of objects format
        const correctOptionObj = mockExamData.currentQuestionData.options.find(optionObj => 
            Object.keys(optionObj)[0] === correctOption
        );
        
        let correctOptionText = '';
        if (correctOptionObj) {
            correctOptionText = correctOptionObj[correctOption];
        }
        
        correctAnswerDiv.innerHTML = `<strong>Correct Answer:</strong> ${correctOption.toUpperCase()}) ${correctOptionText || 'Option text not available'}`;
        correctAnswerDiv.style.display = 'block';
    } else {
        correctAnswerDiv.style.display = 'none';
    }
    
    // Update option visual feedback
    document.querySelectorAll('.option-item').forEach(item => {
        const optionLetter = item.querySelector('.option-letter').textContent.toLowerCase();
        
        if (optionLetter === correctOption) {
            item.classList.add('correct');
        } else if (optionLetter === mockExamData.selectedAnswer && !isCorrect) {
            item.classList.add('incorrect');
        }
        
        // Disable clicking
        item.onclick = null;
        item.style.cursor = 'default';
    });
}

async function showExplanation() {
    const explanationContent = document.getElementById('explanationContent');
    const showBtn = document.getElementById('showExplanationBtn');
    
    if (explanationContent.style.display === 'none') {
        explanationContent.style.display = 'block';
        showBtn.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Hide Explanation';
        
        // Check if explanation already exists for this question
        const currentQuestionKey = mockExamData.currentQuestion;
        if (mockExamData.explanations[currentQuestionKey]) {
            // Load stored explanation
            explanationContent.innerHTML = mockExamData.explanations[currentQuestionKey];
        } else {
            // Generate new explanation
            explanationContent.innerHTML = '<div class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Generating detailed explanation...</div>';
            showBtn.disabled = true;
            
            // Generate explanation using the AI endpoint
            await generateExplanationStream();
            
            showBtn.disabled = false;
        }
    } else {
        explanationContent.style.display = 'none';
        showBtn.innerHTML = '<i class="fas fa-book me-1"></i> Show Explanation';
    }
}

async function generateExplanationStream() {
    const explanationContent = document.getElementById('explanationContent');
    
    if (!mockExamData.currentQuestionData) {
        explanationContent.innerHTML = '<div class="text-danger">Error: No question data available</div>';
        return;
    }
    
    try {
        // Prepare the message content for explanation generation
        const isCorrect = String(mockExamData.selectedAnswer).toLowerCase() === String(mockExamData.currentQuestionData.correct_option).toLowerCase();
        
        const messageContent = `
Question: ${mockExamData.currentQuestionData.question}

Question JSON Data:
${JSON.stringify(mockExamData.currentQuestionData, null, 2)}

User's Response: ${mockExamData.selectedAnswer ? mockExamData.selectedAnswer.toUpperCase() : 'No answer selected'}

Answer Status: ${isCorrect ? 'CORRECT' : 'INCORRECT'}
        `.trim();
        
        const requestData = {
            question: JSON.stringify(mockExamData.currentQuestionData),
            language: getCurrentLanguage(),
            exam_type: examType
        };
        
        // Stream the explanation
        let explanationText = '';
        let explanationSources = [];
        
        const response = await fetch('/generate_explanation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        // Clear the loading message
        explanationContent.innerHTML = '<div class="streaming-explanation"></div>';
        const streamingDiv = explanationContent.querySelector('.streaming-explanation');
        
        function processExplanationStream() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    // Add sources at the end if any
                    if (explanationSources.length > 0) {
                        addSourcesInlineToExplanation(streamingDiv, explanationSources);
                    }
                    return;
                }
                
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        
                        if (data === '[DONE]') {
                            // Add sources at the end if any
                            if (explanationSources.length > 0) {
                                addSourcesInlineToExplanation(streamingDiv, explanationSources);
                            }
                            return;
                        }
                        
                        try {
                            const parsed = JSON.parse(data);
                            
                            if (parsed.type === 'content' || parsed.type === 'final_content') {
                                explanationText += parsed.content;
                                
                                // Convert markdown to HTML and update content
                                const processedContent = explanationText.replace(/\n/g, '\n\n');
                                const htmlContent = marked.parse(processedContent);
                                streamingDiv.innerHTML = htmlContent;
                                
                            } else if (parsed.type === 'tool_usage') {
                                // Show tool usage in explanation
                                const toolUsageText = `\n\n*${parsed.content.replace(/\\n/g, ' ')}*\n\n`;
                                explanationText += toolUsageText;
                                const processedContent = explanationText.replace(/\n/g, '\n\n');
                                const htmlContent = marked.parse(processedContent);
                                streamingDiv.innerHTML = htmlContent;
                                
                            } else if (parsed.type === 'source') {
                                // Store sources to add at the end
                                if (parsed.content && parsed.content.length > 0) {
                                    explanationSources = parsed.content;
                                }
                                
                            } else if (parsed.type === 'error') {
                                explanationContent.innerHTML = `<div class="text-danger">Error generating explanation: ${parsed.content}</div>`;
                                return;
                            }
                        } catch (e) {
                            console.error('Error parsing explanation SSE data:', e, data);
                        }
                    }
                }
                
                return processExplanationStream();
            });
        }
        
        await processExplanationStream();
        
        // Store the generated explanation for future use
        const currentQuestionKey = mockExamData.currentQuestion;
        mockExamData.explanations[currentQuestionKey] = explanationContent.innerHTML;
        
    } catch (error) {
        console.error('Error generating explanation:', error);
        explanationContent.innerHTML = '<div class="text-danger">Failed to generate explanation. Please try again.</div>';
    }
}

function addSourcesInlineToExplanation(explanationDiv, sources) {
    if (!sources || sources.length === 0) return;
    
    // Group sources by document name to avoid duplicates
    const uniqueSources = {};
    sources.forEach(source => {
        const key = `${source.document_name}_${source.page_number}`;
        if (!uniqueSources[key]) {
            uniqueSources[key] = source;
        }
    });
    
    // Generate unique ID for explanation sources
    const sourceId = 'exp-sources-' + Date.now();
    
    let sourceLinksHtml = `
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden;">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; cursor: pointer; transition: all 0.2s ease; user-select: none;" 
                 onclick="toggleSources('${sourceId}')"
                 onmouseover="this.style.background='rgba(255, 255, 255, 0.5)'"
                 onmouseout="this.style.background='transparent'">
                <div style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #4a5568; font-size: 0.9rem;">
                    <i class="fas fa-book-open"></i>
                    <span>Referenced Study Materials (${Object.keys(uniqueSources).length})</span>
                </div>
                <i class="fas fa-chevron-down" style="font-size: 0.8rem; color: #6b7280; transition: transform 0.2s ease;" id="${sourceId}-toggle"></i>
            </div>
            <div style="padding: 0 1rem 1rem 1rem; display: none;" id="${sourceId}-content">
    `;
    
    Object.values(uniqueSources).forEach(source => {
        const fileName = source.document_name || 'Unknown Document';
        const pageNum = source.page_number || 1;
        
        // Create PDF link with page parameter
        const pdfUrl = `/static/files/${fileName}#page=${pageNum}`;
        
        sourceLinksHtml += `
            <a href="${pdfUrl}" 
               target="_blank" 
               style="display: inline-block; margin: 0.25rem 0.5rem 0.25rem 0; padding: 0.5rem 0.75rem; background: white; border: 1px solid #d1d5db; border-radius: 0.5rem; text-decoration: none; color: #374151; font-size: 0.85rem; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
               onmouseover="this.style.background='linear-gradient(135deg, #667eea, #764ba2)'; this.style.color='white'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)';"
               onmouseout="this.style.background='white'; this.style.color='#374151'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)';"
               title="Open ${fileName} at page ${pageNum}">
                <i class="fas fa-file-pdf" style="margin-right: 0.4rem; font-size: 0.8rem;"></i>
                ${fileName.replace('.pdf', '')}, page: ${pageNum}
            </a>
        `;
    });
    
    sourceLinksHtml += '</div></div>';
    
    // Append sources to the explanation content
    explanationDiv.innerHTML += sourceLinksHtml;
}

function previousQuestion() {
    // TODO: Implement navigation to previous questions
    alert('Previous question navigation will be implemented in the next phase!');
}

async function nextQuestion() {
    // Show loading state
    showQuestionLoading();
    
    mockExamData.currentQuestion++;
    mockExamData.selectedAnswer = null;
    
    // Load next question
    await loadNextQuestion(false);
}

function showQuestionLoading() {
    // Update question text to show loading
    document.getElementById('questionText').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading next question...';
    
    // Clear options
    document.getElementById('questionOptions').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2 text-muted">Preparing your next question...</div>
        </div>
    `;
    
    // Update topic to loading
    document.getElementById('questionTopic').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
    
    // Disable all buttons
    document.getElementById('prevBtn').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('nextBtn').disabled = true;
    
    // Hide feedback
    document.getElementById('questionFeedback').style.display = 'none';
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    // Previous button (enable if not first question)
    prevBtn.disabled = mockExamData.currentQuestion <= 1;
    
    // Submit button (disable until option selected)
    submitBtn.disabled = !mockExamData.selectedAnswer;
    
    // Next button (disable until answer submitted)
    nextBtn.disabled = true;
}

function loadExamStats() {
    // Load stats from localStorage
    const stats = JSON.parse(localStorage.getItem('examStats_' + examType) || '{}');
    
    document.getElementById('completedExams').textContent = stats.completed || 0;
    document.getElementById('bestScore').textContent = stats.bestScore ? stats.bestScore + '%' : '--';
}

// Toggle sources visibility
function toggleSources(sourceId) {
    const content = document.getElementById(sourceId + '-content');
    const toggle = document.getElementById(sourceId + '-toggle');
    
    if (content && toggle) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            content.classList.add('show');
            toggle.classList.add('expanded');
        } else {
            content.style.display = 'none';
            content.classList.remove('show');
            toggle.classList.remove('expanded');
        }
    }
}

// Auto-resize textarea
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('messageInput');
    
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            const maxHeight = 120;
            const newHeight = Math.min(this.scrollHeight, maxHeight);
            this.style.height = newHeight + 'px';
        });
    }
    
    // Initialize exam stats
    loadExamStats();
});
</script>
{% endblock %}
